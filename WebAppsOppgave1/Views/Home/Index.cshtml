
@{
    ViewBag.Title = "Index";
}

    <script src="~/Scripts/jquery-3.2.1.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script type="text/javascript">
        $(function () {

            $("#book").hide();

            $.ajax({
                url: '/Home/getAirportNames',
                type: 'GET',
                dataType: 'json',
                success: function (jsAirports) {
                    PopulateAirportDropDowns(jsAirports);
                },
                error: function (x, y, z) {
                    alert(x + '\n' + y + '\n' + z);
                }
            });

            $("#returnFlightChosen").change(function () {
                if ($(this).is(":checked")) {
                    $("#returnLabel").show();
                    $("#return").show();
                } else {
                    $("#returnLabel").hide();
                    $("#return").hide();
                }
            });

            $("#search").click(function () {
                if (validateFields()) {
                    if ($("#departure").val() == "") {
                        var from = $("#fromAirport").val();
                        var to = $("#toAirport").val();
                        
                        $.ajax({
                            url: '/Home/getFlights',
                            type: 'POST',
                            contentType: "application/json:charset=utf-8",
                            data: JSON.stringify({ from: from, to: to }),
                            dataType: 'json',
                            success: function (jsFlights) {
                                DisplayMatchingFlights(jsFlights);
                            },
                            error: function (x, y, z) {
                                alert(x + '\n' + y + '\n' + z);
                            }
                        });
                    }
                    // Call search method with date
                    else {
                        var from = $("#fromAirport").val();
                        var to = $("#toAirport").val();
                        var date = $("#departure").val();

                        $.ajax({
                            url: '/Home/getFlightsOnDate',
                            type: 'POST',
                            contentType: "application/json:charset=utf-8",
                            data: JSON.stringify({ from: from, to: to, date: date }),
                            dataType: 'json',
                            success: function (jsFlights) {
                                DisplayMatchingFlights(jsFlights);
                            },
                            error: function (x, y, z) {
                                alert(x + '\n' + y + '\n' + z);
                            }
                        });
                    }

                    if ($("#returnFlightChosen").is(":checked")) {
                        if ($("#return").val() == "") {
                            var from = $("#toAirport").val();
                            var to = $("#fromAirport").val();
                            $.ajax({
                                url: '/Home/getFlights',
                                type: 'POST',
                                contentType: "application/json:charset=utf-8",
                                data: JSON.stringify({ from: from, to: to }),
                                dataType: 'json',
                                success: function (jsFlights) {
                                    if (jsFlights != null) {
                                        DisplayMatchingReturnFlights(jsFlights);
                                    }
                                },
                                error: function (x, y, z) {
                                    alert(x + '\n' + y + '\n' + z);
                                }
                            });
                        }
                        else {
                            var from = $("#toAirport").val();
                            var to = $("#fromAirport").val();
                            var returnDate = $("#return").val();
                            $.ajax({
                                url: '/Home/getFlightsOnDate',
                                type: 'POST',
                                contentType: "application/json:charset=utf-8",
                                data: JSON.stringify({ from: from, to: to, date: returnDate }),
                                dataType: 'json',
                                success: function (jsFlights) {
                                    if (jsFlights != null) {
                                        DisplayMatchingReturnFlights(jsFlights);
                                    }
                                },
                                error: function (x, y, z) {
                                    alert(x + '\n' + y + '\n' + z);
                                }
                            });
                        }
                    } else {
                        $("#displayReturnFlights").html("");
                    }
                    $("#book").show();
                }
            });


            $("#book").click(function () {
                if ($("input[name=radioSelectorReturnFlight]").is(":checked") && validateArrivalBeforeReturn()) {
                    var flight = $("input[name=radioSelectorReturnFlight]:checked").val();
                    var amount = $("#returnTicketAmount").val();

                    $.ajax({
                        url: '/Home/Register',
                        type: 'POST',
                        contentType: "application/json:charset=utf-8",
                        data: JSON.stringify({ flight: flight, amount: amount }),
                        dataType: 'json',
                        async: false,
                        success: function (string) {
                            // Do nothing, have to check if return flight is ordered first.
                        },
                        error: function (x, y, z) {
                            alert(x + '\n' + y + '\n' + z);
                        }
                    });
                }

                var flight = $("input[name=radioSelectorFlight]:checked").val();
                var amount = $("#ticketAmount").val();

                $.ajax({
                    url: '/Home/Register',
                    type: 'POST',
                    contentType: "application/json:charset=utf-8",
                    data: JSON.stringify({ flight: flight, amount: amount }),
                    dataType: 'json',
                    async: false,
                    success: function (string) {
                        window.location.href = "/Home/Bookings/";
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });

                
            });
        });
        
        

        function PopulateAirportDropDowns(jsAirports) {
            var result = "";
            for (var a in jsAirports) {
                result += "<option value='" + jsAirports[a].id + "'>" + jsAirports[a].name + "</option>";
            }
            $("#fromAirport").append(result);
            $("#toAirport").append(result);
        }

        function DisplayMatchingFlights(jsFlights) {
            var result =
                "<table class='table'>" +
                    "<thead>" +
                        "<tr>" +
                            "<th>Velg</th>" +
                            "<th>Fra</th>" +
                            "<th>Til</th>" +
                            "<th>Avreise</th>" +
                            "<th>Ankomst</th>" +
                            "<th>Pris</th>"
                        "</tr>" +
                    "</thead >";
            for (var f in jsFlights) {
                result +=
                    "<tr>" +
                    "<td><input type=\"radio\" name =\"radioSelectorFlight\" value=\"" + jsFlights[f].id + "\"></td>" +
                    "<td id=\"" + jsFlights[f].id + "fromAirport\">" + jsFlights[f].fromAirport + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "toAirport\">" + jsFlights[f].toAirport + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "departure\">" + jsFlights[f].departure + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "arrival\">" + jsFlights[f].arrival + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "price\">" + jsFlights[f].price + "</td>" +
                    "</tr>"
            }
            result += "<tr>" +
                        "<td></td><td></td><td></td>" +
                        "<td align=\"right\"><strong>Velg antall:</strong></td>" +
                        "<td><input type=\"number\" id=\"ticketAmount\" max=\"10\" min=\"1\" />" +
                    "</tr></table>";
            $("#displayFlights").html(result);
        }

        function DisplayMatchingReturnFlights(jsFlights) {
            var result =
                "<table class='table'>" +
                "<thead>" +
                "<tr>" +
                "<th>Velg</th>" +
                "<th>Fra</th>" +
                "<th>Til</th>" +
                "<th>Avreise</th>" +
                "<th>Ankomst</th>" +
                "<th>Pris</th>" +
                "</tr>" +
                "</thead >";
            for (var f in jsFlights) {
                result +=
                    "<tr>" +
                    "<td><input type=\"radio\" name=\"radioSelectorReturnFlight\" value=\"" + jsFlights[f].id + "\"></td>" +
                    "<td id=\"" + jsFlights[f].id + "fromAirport\">" + jsFlights[f].fromAirport + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "toAirport\">" + jsFlights[f].toAirport + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "departure\">" + jsFlights[f].departure + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "arrival\">" + jsFlights[f].arrival + "</td>" +
                    "<td id=\"" + jsFlights[f].id + "price\">" + jsFlights[f].price + "</td>" +
                    "</tr>";
                    
                    
            }
            result += "<tr>" +
                "<td></td><td></td><td></td>" +
                "<td align=\"right\"><strong>Velg antall:</strong></td>" +
                "<td> <input type=\"number\" id=\"returnTicketAmount\" max=\"10\" min=\"1\" /></td>" +
                "</tr></table> ";
            $("#displayReturnFlights").html(result);
        }

    </script>

    <h2>Bestill flytur</h2>
    
    <div class="row">
        <div class="col-sm-6">
            <fieldset>
                <legend>Fly fra:</legend>
                <label>Destinasjon:</label>
                <br />
                <select id="fromAirport">
                    <option selected hidden value="">Velg flyplass</option>
                </select>
                &nbsp;<span class="label label-warning" id="fromAirportWarning" style="display:none">Må fylles ut</span>
                <br />
                <label>Avreise:</label><br />
                <input type="date" id="departure" />
                &nbsp;<span class="label label-warning" id="departureWarning" style="display:none">Må fylles ut</span>
                <br />
                <input type="checkbox" id="returnFlightChosen" />Tur/retur<br/>
            </fieldset>
            <br /><button id="search">Søk</button><br/>
        </div>

        <div class="col-sm-6">
            <fieldset>
                <legend>Fly til:</legend>
                <label>Destinasjon:</label><br />
                <select id="toAirport">
                    <option selected hidden value="">Velg flyplass</option>
                </select>
                &nbsp;<span class="label label-warning" id="toAirportWarning" style="display:none">Må fylles ut</span>
                <br />
                <label id="returnLabel" style="display:none">Hjemreise:</label><br />
                <input type="date" id="return" style="display:none"/>
                &nbsp;<span class="label label-warning" id="returnWarning" style="display:none">Må fylles ut</span>
                <br />
            </fieldset>
        </div>
    </div>
    <div id="displayFlights" class="col-sm-6"></div>
    <div id="displayReturnFlights" class="col-sm-6"></div>
    <div><span class="label label-warning" id="returnWarning" style="display:none"></span></div>
    <br /><button id="book">Bestill</button>

    <script>
        function validateFields() {
 
            var validateFromAirport = $("#fromAirport").val();
            var validateDeparture = $("#departure").val();
            var validateToAirport = $("#toAirport").val();
            var validateReturn = $("#return").val();

            var validationOK = true;
            hideWarnings();

            if ((validateDeparture != "" && validateReturn != "") && (validateDeparture > validateReturn)) {
                
                document.getElementById("returnWarning").innerHTML = "Dato må være etter avreise";
                document.getElementById("returnWarning").style.display = "inline";
                validationOK = false;
            } else {
                document.getElementById("returnWarning").style.display = "none";
            }

            if (validateFromAirport == validateToAirport && validateFromAirport != "") {
           
                document.getElementById("toAirportWarning").innerHTML = "Du kan ikke reise til og fra samme sted";
                document.getElementById("toAirportWarning").style.display = "inline";
                validationOK = false;
            } else {
                document.getElementById("toAirportWarning").style.display = "none";
            }

            if (validateFromAirport == "") {
             
                document.getElementById("fromAirportWarning").innerHTML = "Må fylles ut";
                document.getElementById("fromAirportWarning").style.display = "inline";
                validationOK = false;
            } else {
                document.getElementById("fromAirportWarning").style.display = "none";
            }

            if (validateToAirport == "") {
             
                document.getElementById("toAirportWarning").innerHTML = "Må fylles ut";
                document.getElementById("toAirportWarning").style.display = "inline";
                validationOK = false;
            } else {
                document.getElementById("toAirportWarning").style.display = "none";
            }

            return validationOK;
        }        

        function validateArrivalBeforeReturn() {

            var flightId = $("input[name=radioSelectorFlight]:checked").val();
            var returnFlightId = $("input[name=radioSelectorReturnFlight]:checked").val();
            var flightArrival = $("#" + flightId + "arrival").val();
            var returnDeparture = $("#" + returnFlightId + "departure").val();

            if (returnDeparture <= flightArrival) {

                document.getElementById("returnWarning").innerHTML = "Retur må være etter ankomst";
                document.getElementById("returnWarning").style.display = "inline";
                $("input[name=radioSelectorReturnFlight").prop("checked", false);
                return false;

            } else {
                document.getElementById("returnWarning").style.display = "none";
                return true;
            }
        }

        function hideWarnings() {

            document.getElementById("fromAirportWarning").style.display = "none";
            document.getElementById("toAirportWarning").style.display = "none";
            document.getElementById("departureWarning").style.display = "none";
            document.getElementById("returnWarning").style.display = "none";
        }
    </script>
